---
title: "2025 HCTF Sampling Proposals"
author: "Chris Madsen"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
library(sf)
library(leaflet)

```

## Interactive Map

```{r}
dat_sf = sf::read_sf("data/2025_sampling_locations.gpkg")

all_shortlist_lakes = sf::read_sf("W:/CMadsen/Projects/ZQMussels/2025 IMDP Final Report/data/spatial/waterbodies_zqm_shortlist_risk_estimates.gpkg") |> 
  sf::st_transform(4326)

proposed_wb_names = unique(dat_sf$waterbody_name)
shortlist_wb_names = unique(all_shortlist_lakes$GNIS_NA)

dat_sf = dat_sf |> 
  dplyr::mutate(waterbody_is_on_priority_list = waterbody_name %in% shortlist_wb_names)

all_shortlist_lakes = all_shortlist_lakes |> 
  dplyr::mutate(proposed_sampling = GNIS_NA %in% proposed_wb_names)

# simplify lake geometries a bit.
all_shortlist_lakes_s = sf::st_simplify(all_shortlist_lakes, dTolerance = 20)

dat_sf_on_list = dat_sf[dat_sf$waterbody_is_on_priority_list,]
dat_sf_not_on_list = dat_sf[!dat_sf$waterbody_is_on_priority_list,]

# Create interactive map.
my_pal = leaflet::colorFactor(palette = "Set3", domain = unique(dat_sf$Group))

sampling_dots_outline_pal = leaflet::colorFactor(palette = c("red","black"), domain = unique(dat_sf$waterbody_is_on_priority_list))

dat_sf_on_list_tbls = leafpop::popupTable(
  dat_sf_on_list |> 
    sf::st_drop_geometry() |> 
    dplyr::select(-does_the_proposed_sampling_frequency_differ_from_current_priority_list) |> 
    dplyr::mutate(dplyr::across(c(on_last_years_priority_waterbody_list,sampled_last_year,substrate_sampler_planned), \(x) ifelse(x == "Y", "Yes", "No"))) |> 
    # dplyr::mutate(justification_for_sampling = stringr::str_replace_all(justification_for_sampling, "[\\,,\\.]", "<br>")) |> 
    dplyr::mutate(justification_for_sampling = gsub("((?:\\S+\\s+){6}\\S+)([ ,\\.])", "\\1<br>", justification_for_sampling, perl = TRUE))
)

dat_sf_not_on_list_tbls = leafpop::popupTable(
  dat_sf_not_on_list |> 
    sf::st_drop_geometry() |> 
    dplyr::select(-does_the_proposed_sampling_frequency_differ_from_current_priority_list) |> 
    dplyr::mutate(dplyr::across(c(on_last_years_priority_waterbody_list,sampled_last_year,substrate_sampler_planned), \(x) ifelse(x == "Y", "Yes", "No"))) |> 
    dplyr::mutate(justification_for_sampling = gsub("((?:\\S+\\s+){6}\\S+)([ ,\\.])", "\\1<br>", justification_for_sampling, perl = TRUE))
)

leaflet(width = '100%') |>
  addTiles(group = "OpenStreetMap") |>
  addProviderTiles(providers$CartoDB, group = "cartoDB") |>
  addLayersControl(position = 'bottomleft', 
                   baseGroups = c("cartoDB","OpenStreetMap"),
                   overlayGroups = c("not_on_priority_list",
                                     "on_priority_list",
                                     "waterbodies"),
                   options = layersControlOptions(collapsed = F)) |>
  leaflet::addMapPane(name = "waterbodies", zIndex = 300) |>
  leaflet::addMapPane(name = "sampling_points", zIndex = 500) |>
  addPolygons(
    data = all_shortlist_lakes_s,
    color = ~ifelse(proposed_sampling, "darkgreen","purple"),
    label = ~GNIS_NA,
    options = pathOptions(pane = "waterbodies"),
    group = 'waterbodies'
  ) |> 
  addCircleMarkers(
    data = dat_sf_on_list,
    fillColor = ~my_pal(Group),
    color = ~sampling_dots_outline_pal(waterbody_is_on_priority_list),
    fillOpacity = 0.75,
    weight = 1.5,
    label = ~lapply(dat_sf_on_list_tbls, htmltools::HTML),
    group = "on_priority_list",
    options = pathOptions(pane = "sampling_points")
  ) |>
  addCircleMarkers(
    data = dat_sf_not_on_list,
    fillColor = ~my_pal(Group),
    color = ~sampling_dots_outline_pal(waterbody_is_on_priority_list),
    fillOpacity = 0.75,
    weight = 1.5,
    label = ~lapply(dat_sf_not_on_list_tbls, htmltools::HTML),
    group = "not_on_priority_list",
    options = pathOptions(pane = "sampling_points")
  ) |> 
  addLegend(pal = my_pal, values = unique(dat_sf$Group)) |>
  addLegend(pal = sampling_dots_outline_pal, values = unique(dat_sf$waterbody_is_on_priority_list), title = "On Priority List") |>
  addScaleBar('bottomright') |>
  leaflet.extras::addResetMapButton()
```

